# [架构300讲](https://www.bilibili.com/video/BV1WM4y1N79G/)

---
## 001 架构师
1. 不谈场景的架构设计都是耍流氓；架构没有对不对，只有合适不合适
2. 尽量从问题的源头进行分析，在不增加系统复杂度的前提下解决问题
3. 架构是宏观设计的标准；架构是具体实现的规则
### 问题
1. 大量文件读写过程中影响到服务器的磁盘 IO，导致数据库查询出现高延迟。
    1. Web 容器层面增加拦截器阻挡垃圾重复无效的请求穿透到数据库
    2. 分析业务代码中 SQL 是否存在全表扫描以及索引选择性问题
    3. 增加 InnoDB 引擎的 Buffer_Pool 让查询拥有更多的缓存命中率
    4. 在操作系统层面，增加文件系统缓存，减少文件 IO 次数
---
## 002 MySQL 集群模式
1. 读写分离
    - 所有节点数据均保持同步
    - 适用于读多写少，单表不过千万的互联网应用
    - 配合 MHA 中间件实现高可用
```
                  +-----------+
                  | mall app  |
                  +-----------+
                        ↓
            +-----------------------+
            | Shardding Middleware  |
        ----|        [MyCat]        |----
        |   |   [ShardingSphere]    |   |
        |   +-----------|-----------+   |
      read            write            read
        |         +-----↓-----+         |
        |         | master-db |         |
        |         +-----|-----+         |
        ↓             binlog            ↓
    +-----------+       |       +-----------+
    | slave-db1 |←------+------→| slave-db2 |                 
    +-----------+               +-----------+
```
2. 分片（分库分表）
    - 每个节点数据是素有数据的子集
    - 适用于十亿级数据总量大型应用
    - 不具备高可用
```
                  +-----------+
                  | mall app  |
                  +-----------+
                        ↓
            +-----------------------+
            | Shardding Middleware  |
            |        [MyCat]        |
            |   [ShardingSphere]    |
            +-----------|-----------+
                      route
          +-------------+-------------+
    +-----↓-----+ +-----↓-----+ +-----↓-----+
    | master-db | | master-db | | master-db |
    |   shard   | |   shard   | |   shard   |
    +-----------+ +-----------+ +-----------+
```
3. 分片+读写分离
```
                  +-----------+
                  | mall app  |
                  +-----------+
                        ↓
            +-----------------------+
            | Shardding Middleware  |
            |        [MyCat]        |
            |   [ShardingSphere]    |
            +-----------|-----------+
                      route
          +-------------+-------------+
    +-----↓-----+ +-----↓-----+ +-----↓-----+
    | master-db | | master-db | | master-db |
    |   shard   | |   shard   | |   shard   |
    +-----------+ +-----------+ +-----------+
          ↓             ↓             ↓
    +-----------+ +-----------+ +-----------+
    | slave-db1 | | slave-db1 | | slave-db1 |
    +-----------+ +-----------+ +-----------+
    | slave-db2 | | slave-db2 | | slave-db2 |
    +-----------+ +-----------+ +-----------+
```
### 分片算法
1. 范围法
    - 适合范围检索
    - 数据分布不均匀，局部负载压力大
    - 结构简单，扩展容易
    - 适用于流水账应用
```
    +---------------------------------------+
    |   +-----+      +-----+      +-----+   |     
    |   |1000-|      |3000-|      |5000-|   |
    |   |2000 |      |4000 |      |6000 |   |
    |   +-----+      +-----+      +-----+   |
    +---------------------------------------+
```
2. 哈希法
    - 类型：①取模；②一致性 Hash
    - 数据分布平均
    - 节点扩展复杂，数据迁移难度大；建议提前部署足够的节点
    - 适用于预算充足的大型互联网应用
```
    +---------------------------------------+
    |   +-----+      +-----+      +-----+   |     
    |   |0,3,6|      |1,4,7|      |2,5,8|   |
    |   +-----+      +-----+      +-----+   |
    +---------------------------------------+
```
---
## 003 数据库垂直分表
- 垂直分表：将一张大表按列拆分为2张以上的小表，通过主外键关联来获取数据
- 为什么要垂直分表？：减少跨页检索，增加页内检索
- 原理：通过将重要字段单独剥离出一张小表，让每一页能够容纳更多的行，进而缩小数据扫描的范围，达到提高执行效率的目的
- 什么情况下考虑垂直分表
    1. 单表数据量可能过千万
    2. 字段超过20个，且包含了超长的 Varchar、CLOB、BLOB 等字段
- 字段分配
    - 小表字段：高频访问的小字段、排序字段、逻辑删除字段等
    - 大表字段：低频访问字段、大字段
---
## 004 多级缓存
```
------------------------------------------------------------
         ------ static -----+----- sattic ------        客户端
         |     resource     ↓     resource     |
---------|---------------+-----+---------------|------------
         |               | CDN |               |        应用层
         |               +-----+               |
         |                  ↓                  |
         |              +-------+              |
         '- dynamic --→ | Nginx | ←-- dynamic -'
            access      +-------+      access
                            ↓
                  +--------------------+
                  | Tomcat App Cluster |
------------------+--------------------+--------------------
                            ↓                           服务层
                     +-------------+
                     | API Gateway |
                     +-------------+
         -------------------+-------------------
         ↓                  ↓                  ↓
    +---------+        +---------+        +---------+
    |  Goods  |        |  Order  |        |Logistics|
    | Service |        | Service |        | Service |
    | EhCache |        | EhCache |        | EhCache |
    +---------+        +-|-----|-+        +---------+
      |     |          read  write          |     |
      |     |    +-------↓-------------+    |     |
    write  read →|        Redis        |← read  write
      |          +---------------------+          |
------|------------↑-----↑-----|-----↑------------|---------
      ↓          Sync   Sync   ↓    Sync          ↓     数据层
  +-------------+  | +-------------+ |  +-------------+ 
  |  Goods  DB  |--' |  Order  DB  | '--|Logistics  DB|
  +-------------+    +-------------+    +-------------+
------------------------------------------------------------
```
---
